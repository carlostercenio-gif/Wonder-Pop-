<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WONDER POP V7 ULTIMATE - La Aventura Definitiva</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 450px;
            max-height: 800px;
            background: #000;
            border: 8px solid #FFD700;
            box-shadow: 
                0 0 40px rgba(255, 215, 0, 0.8),
                inset 0 0 20px rgba(255, 215, 0, 0.3);
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #gameContainer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1),
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 10000;
        }

        #splashScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FF1493 0%, #FFD700 25%, #00FFFF 50%, #32CD32 75%, #FF1493 100%);
            background-size: 400% 400%;
            animation: rainbowShift 4s ease infinite;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.8s;
        }

        @keyframes rainbowShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #splashScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .title {
            font-size: 48px;
            font-weight: 900;
            color: #FFF;
            text-shadow: 
                4px 4px 0 #000,
                -2px -2px 0 #FFD700,
                6px 6px 0 #FF1493;
            letter-spacing: 6px;
            animation: megaPop 0.6s ease infinite alternate;
            margin-bottom: 10px;
        }

        @keyframes megaPop {
            from { transform: scale(1) rotate(-1deg); }
            to { transform: scale(1.05) rotate(1deg); }
        }

        .subtitle {
            font-size: 16px;
            color: #000;
            background: linear-gradient(90deg, #FFD700, #FFF, #FFD700);
            padding: 10px 25px;
            border-radius: 20px;
            margin-bottom: 10px;
            font-weight: 900;
            letter-spacing: 2px;
            box-shadow: 0 4px 0 #000;
        }

        .newLabel {
            font-size: 13px;
            color: #FF1493;
            background: #000;
            padding: 8px 18px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 3px solid #FF1493;
            font-weight: 900;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .location {
            font-size: 12px;
            color: #FFF;
            background: rgba(0, 0, 0, 0.8);
            padding: 6px 15px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #FFD700;
        }

        .characters {
            font-size: 60px;
            margin-bottom: 30px;
            animation: superBounce 1.2s ease infinite;
            filter: drop-shadow(3px 3px 0 #000);
        }

        @keyframes superBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-20px) scale(1.05); }
            50% { transform: translateY(-25px) scale(1.08); }
            75% { transform: translateY(-20px) scale(1.05); }
        }

        .startBtn {
            font-size: 24px;
            font-weight: 900;
            color: #000;
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%);
            border: 5px solid #000;
            padding: 18px 50px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 4px;
            box-shadow: 8px 8px 0 #000;
            transition: all 0.1s;
            animation: megaPulse 1.5s ease infinite;
            border-radius: 10px;
        }

        @keyframes megaPulse {
            0%, 100% { box-shadow: 8px 8px 0 #000; }
            50% { box-shadow: 12px 12px 0 #000; }
        }

        .startBtn:active {
            transform: translate(4px, 4px);
            box-shadow: 4px 4px 0 #000;
        }

        .credits {
            position: absolute;
            bottom: 20px;
            font-size: 11px;
            color: #FFF;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: bold;
            border: 2px solid #FFD700;
        }

        #characterScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1999;
            padding: 20px;
            overflow-y: auto;
        }

        #characterScreen.show {
            display: flex;
        }

        .charSelectTitle {
            font-size: 32px;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 3px 3px 0 #000;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .characterGrid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .characterCard {
            width: 150px;
            height: 200px;
            background: linear-gradient(135deg, #2a2a4e 0%, #1a1a3e 100%);
            border: 4px solid #FFD700;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 10px;
        }

        .characterCard:active {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.6);
        }

        .characterCard.selected {
            border-color: #32CD32;
            border-width: 6px;
            box-shadow: 0 0 20px rgba(50, 205, 50, 0.8);
        }

        .characterEmoji {
            font-size: 60px;
            margin-bottom: 10px;
        }

        .characterName {
            font-size: 14px;
            font-weight: 900;
            color: #FFF;
            text-shadow: 2px 2px 0 #000;
            margin-bottom: 8px;
        }

        .characterPower {
            font-size: 10px;
            color: #FFD700;
            font-weight: bold;
            text-align: center;
            line-height: 1.3;
        }

        .playBtn {
            font-size: 22px;
            font-weight: 900;
            color: #000;
            background: #32CD32;
            border: 4px solid #000;
            padding: 15px 40px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 3px;
            box-shadow: 6px 6px 0 #000;
            transition: all 0.1s;
            border-radius: 12px;
        }

        .playBtn:active {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0 #000;
        }

        .playBtn.disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* ‚úÖ INTRO PERSONAJES - ARREGLADO PARA M√ìVIL */
        #introScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000 0%, #1a1a2e 100%);
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 1998;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #introScreen.show {
            display: flex;
        }

        .introTitle {
            font-size: 28px;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 4px 4px 0 #000;
            margin: 20px 0;
            text-align: center;
        }

        .introGrid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
            width: 100%;
            max-width: 380px;
        }

        .introCard {
            background: rgba(255, 255, 255, 0.1);
            border: 4px solid #FFD700;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.5s ease forwards;
            opacity: 0;
        }

        .introCard:nth-child(1) { animation-delay: 0.1s; }
        .introCard:nth-child(2) { animation-delay: 0.3s; }
        .introCard:nth-child(3) { animation-delay: 0.5s; }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .introEmoji {
            font-size: 55px;
            filter: drop-shadow(3px 3px 0 #000);
        }

        .introInfo {
            flex: 1;
        }

        .introName {
            font-size: 20px;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 2px 2px 0 #000;
            margin-bottom: 6px;
        }

        .introDesc {
            font-size: 12px;
            color: #FFF;
            line-height: 1.3;
        }

        .skipBtn {
            font-size: 20px;
            font-weight: 900;
            color: #FFF;
            background: linear-gradient(180deg, #32CD32 0%, #228B22 100%);
            border: 4px solid #000;
            padding: 15px 45px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 6px 6px 0 #000;
            border-radius: 12px;
            margin: 20px 0 30px 0;
        }

        .skipBtn:active {
            transform: translate(3px, 3px);
            box-shadow: 3px 3px 0 #000;
        }

        #shopScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1997;
            padding: 20px;
        }

        #shopScreen.show {
            display: flex;
        }

        .shopTitle {
            font-size: 28px;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 3px 3px 0 #000;
            margin-bottom: 10px;
        }

        .shopSubtitle {
            font-size: 14px;
            color: #00FFFF;
            margin-bottom: 20px;
        }

        .shopItems {
            background: rgba(26, 26, 62, 0.9);
            border: 4px solid #FFD700;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 350px;
        }

        .shopItem {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shopItem:active {
            transform: scale(0.98);
            background: rgba(50, 205, 50, 0.3);
        }

        .shopItemName {
            font-size: 16px;
            font-weight: bold;
            color: #FFF;
        }

        .shopItemPrice {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
        }

        .shopPoints {
            font-size: 18px;
            color: #00FFFF;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .shopBtn {
            font-size: 20px;
            font-weight: 900;
            color: #FFF;
            background: #FF1493;
            border: 4px solid #000;
            padding: 12px 40px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 5px 5px 0 #000;
            border-radius: 10px;
            transition: all 0.1s;
        }

        .shopBtn:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0 #000;
        }

        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.97);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1996;
        }

        #gameOverScreen.show {
            display: flex;
        }

        .gameOverTitle {
            font-size: 60px;
            font-weight: 900;
            color: #FF1493;
            text-shadow: 5px 5px 0 #000;
            margin-bottom: 20px;
            animation: shakeHard 0.5s ease;
        }

        @keyframes shakeHard {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        .finalScore {
            font-size: 32px;
            color: #00FFFF;
            margin-bottom: 15px;
            font-weight: 900;
            text-shadow: 2px 2px 0 #000;
        }

        .highScore {
            font-size: 20px;
            color: #FFD700;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .retryBtn {
            font-size: 20px;
            font-weight: 900;
            color: #FFF;
            background: linear-gradient(180deg, #FF1493 0%, #C71585 100%);
            border: 4px solid #000;
            padding: 15px 40px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 3px;
            box-shadow: 6px 6px 0 #000;
            transition: all 0.1s;
            border-radius: 12px;
            margin: 8px;
        }

        .retryBtn:active {
            transform: translate(2px, 2px);
            box-shadow: 4px 4px 0 #000;
        }

        #controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 1995;
        }

        .controlBtn {
            font-size: 22px;
            background: rgba(255, 215, 0, 0.95);
            border: 3px solid #000;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 900;
            box-shadow: 3px 3px 0 #000;
        }

        .controlBtn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 #000;
        }

        /* ‚úÖ INDICADOR DE PERSONAJE CERCA */
        .char-alert {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 215, 0, 0.95);
            border: 5px solid #000;
            border-radius: 20px;
            padding: 20px 40px;
            font-size: 24px;
            font-weight: 900;
            color: #000;
            text-align: center;
            box-shadow: 10px 10px 0 #000;
            animation: alertPop 0.8s ease;
            z-index: 1994;
        }

        @keyframes alertPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="splashScreen">
            <div class="title">WONDER POP</div>
            <div class="subtitle">üéÆ V7 ULTIMATE üéÆ</div>
            <div class="newLabel">‚ö° NUEVO: MISIONES + BOSS! ‚ö°</div>
            <div class="location">üìç Delivery desde San Justo üá¶üá∑</div>
            <div class="characters">ü•ëüçÖü•ïüçÜ</div>
            <button class="startBtn" onclick="showCharacterSelect()">PRESS START</button>
            <div class="credits">¬© COCINA POP STUDIOS 2026</div>
        </div>

        <div id="characterScreen">
            <div class="charSelectTitle">¬°ELEG√ç TU CHEF!</div>
            <div class="characterGrid">
                <div class="characterCard" onclick="selectCharacter(0)">
                    <div class="characterEmoji">üçÖ</div>
                    <div class="characterName">TOMATO</div>
                    <div class="characterPower">üõ°Ô∏è SALSA SHIELD<br>Escudo cada 15seg</div>
                </div>
                <div class="characterCard" onclick="selectCharacter(1)">
                    <div class="characterEmoji">ü•ë</div>
                    <div class="characterName">AGUACATE</div>
                    <div class="characterPower">üí® AVOCADO DASH<br>Velocidad x2 + Im√°n</div>
                </div>
                <div class="characterCard" onclick="selectCharacter(2)">
                    <div class="characterEmoji">ü•ï</div>
                    <div class="characterName">ZANAHORIA</div>
                    <div class="characterPower">ü¶ò DOUBLE JUMP<br>Salta 2 veces!</div>
                </div>
                <div class="characterCard" onclick="selectCharacter(3)">
                    <div class="characterEmoji">üçÜ</div>
                    <div class="characterName">BERENJENA</div>
                    <div class="characterPower">üí• GROUND POUND<br>Destruye obst√°culos</div>
                </div>
            </div>
            <button class="playBtn disabled" id="playBtn" onclick="showIntro()">¬°JUGAR!</button>
        </div>

        <!-- ‚úÖ INTRO PERSONAJES - ARREGLADO -->
        <div id="introScreen">
            <div class="introTitle">¬°CONOC√â A LOS PERSONAJES!</div>
            <div class="introGrid">
                <div class="introCard">
                    <div class="introEmoji">üë®‚Äçüç≥</div>
                    <div class="introInfo">
                        <div class="introName">EL CHEF POP</div>
                        <div class="introDesc">Te da PODER CHEF: x3 puntos + invencibilidad!</div>
                    </div>
                </div>
                <div class="introCard">
                    <div class="introEmoji">üì∏</div>
                    <div class="introInfo">
                        <div class="introName">IVANCITO</div>
                        <div class="introDesc">Fot√≥grafo fashion. Te saca 3 fotos "¬°DIVINA!" = +450 pts</div>
                    </div>
                </div>
                <div class="introCard">
                    <div class="introEmoji">üé§</div>
                    <div class="introInfo">
                        <div class="introName">LUISITO</div>
                        <div class="introDesc">Locutor! "¬°ZARLANGAS MA√ëANAS!" = Premios random</div>
                    </div>
                </div>
            </div>
            <button class="skipBtn" onclick="startGameWithChar()">¬°EMPEZAR!</button>
        </div>

        <div id="shopScreen">
            <div class="shopTitle">üè™ COCINA POP</div>
            <div class="shopSubtitle">San Justo - ¬°Recarg√° y segu√≠!</div>
            <div class="shopPoints">TUS PUNTOS: <span id="shopPointsValue">0</span></div>
            <div class="shopItems">
                <div class="shopItem" onclick="buyItem('life')">
                    <div class="shopItemName">‚ù§Ô∏è +1 VIDA</div>
                    <div class="shopItemPrice">300 pts</div>
                </div>
                <div class="shopItem" onclick="buyItem('shield')">
                    <div class="shopItemName">üõ°Ô∏è ESCUDO</div>
                    <div class="shopItemPrice">400 pts</div>
                </div>
                <div class="shopItem" onclick="buyItem('magnet')">
                    <div class="shopItemName">üß≤ IM√ÅN</div>
                    <div class="shopItemPrice">350 pts</div>
                </div>
                <div class="shopItem" onclick="buyItem('slow')">
                    <div class="shopItemName">‚è∞ SLOW-MO</div>
                    <div class="shopItemPrice">300 pts</div>
                </div>
            </div>
            <button class="shopBtn" onclick="closeShop()">VOLVER AL JUEGO</button>
        </div>

        <div id="controls" style="display:none;">
            <button class="controlBtn" onclick="toggleAudio()">üîä</button>
        </div>

        <div id="gameOverScreen">
            <div class="gameOverTitle">GAME OVER!</div>
            <div class="finalScore">SCORE: <span id="finalScoreValue">0</span></div>
            <div class="highScore">HIGH SCORE: <span id="highScoreValue">0</span></div>
            <button class="retryBtn" onclick="retry()">REINTENTAR</button>
            <button class="retryBtn" onclick="location.reload()">CAMBIAR CHEF</button>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 450;
        canvas.height = 800;

        const colors = {
            black: '#000000',
            white: '#FFFFFF',
            red: '#FF4444',
            orange: '#FF8833',
            yellow: '#FFD700',
            lime: '#32CD32',
            green: '#22AA44',
            cyan: '#00FFFF',
            blue: '#4444FF',
            pink: '#FF1493',
            purple: '#8B00FF',
            brown: '#8B4513',
            sky1: '#87CEEB',
            sky2: '#4A90E2',
            building: '#8B7355'
        };

        const characters = [
            { 
                name: 'TOMATO', 
                emoji: 'üçÖ', 
                color: colors.red, 
                speed: 1.0, 
                jump: 1.25,
                defense: 1.0,
                powerType: 'shield',
                powerCooldown: 900,
                powerDuration: 180
            },
            { 
                name: 'AGUACATE', 
                emoji: 'ü•ë', 
                color: colors.green, 
                speed: 1.3, 
                jump: 1.15,
                defense: 0.8,
                powerType: 'dash',
                powerCooldown: 720,
                powerDuration: 180
            },
            { 
                name: 'ZANAHORIA', 
                emoji: 'ü•ï', 
                color: colors.orange, 
                speed: 0.9, 
                jump: 1.5,
                defense: 0.9,
                powerType: 'doubleJump',
                powerCooldown: 0,
                powerDuration: 0
            },
            { 
                name: 'BERENJENA', 
                emoji: 'üçÜ', 
                color: colors.purple, 
                speed: 0.8, 
                jump: 1.2,
                defense: 1.5,
                powerType: 'groundPound',
                powerCooldown: 0,
                powerDuration: 0
            }
        ];

        let selectedCharIndex = -1;
        let selectedChar = null;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚úÖ AUDIO MEJORADO
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let audioEnabled = true;
        let audioContext = null;
        let bgmPlaying = false;
        let bossMusicPlaying = false;
        let introMusicPlaying = false;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playNote(freq, duration, type = 'square', volume = 0.2) {
            if (!audioEnabled || !audioContext) return;
            
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            
            osc.type = type;
            osc.frequency.value = freq;
            
            gain.gain.setValueAtTime(volume, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + duration);
        }

        // ‚úÖ M√öSICA INTRO - √âpica y misteriosa
        function playIntroMusic() {
            if (!audioEnabled || introMusicPlaying) return;
            introMusicPlaying = true;
            
            const introMelody = [
                {note: 261.63, duration: 0.4}, // C
                {note: 293.66, duration: 0.4}, // D
                {note: 329.63, duration: 0.4}, // E
                {note: 392.00, duration: 0.6}, // G
                {note: 329.63, duration: 0.4}, // E
                {note: 392.00, duration: 0.8}, // G
            ];
            
            let time = 0;
            introMelody.forEach(({note, duration}) => {
                setTimeout(() => {
                    playNote(note, duration, 'sine', 0.15);
                    playNote(note/2, duration, 'triangle', 0.1);
                }, time * 1000);
                time += duration;
            });
            
            setTimeout(() => {
                introMusicPlaying = false;
            }, (time + 0.3) * 1000);
        }

        function playBGM() {
            if (!audioEnabled || bgmPlaying || bossMusicPlaying) return;
            bgmPlaying = true;
            
            const melody = [
                {note: 523.25, duration: 0.15},
                {note: 659.25, duration: 0.15},
                {note: 783.99, duration: 0.15},
                {note: 880.00, duration: 0.25},
                {note: 783.99, duration: 0.15},
                {note: 659.25, duration: 0.15},
                {note: 698.46, duration: 0.2},
                {note: 783.99, duration: 0.3},
            ];
            
            let time = 0;
            melody.forEach(({note, duration}) => {
                setTimeout(() => {
                    playNote(note, duration, 'square', 0.12);
                    playNote(note/2, duration, 'triangle', 0.06);
                }, time * 1000);
                time += duration;
            });
            
            setTimeout(() => {
                bgmPlaying = false;
                if (gameStarted && !paused && !boss) playBGM();
            }, (time + 0.3) * 1000);
        }

        function playBossMusic() {
            if (!audioEnabled || bossMusicPlaying) return;
            bossMusicPlaying = true;
            bgmPlaying = false;
            
            const bossMelody = [
                {note: 329.63, duration: 0.12},
                {note: 329.63, duration: 0.12},
                {note: 349.23, duration: 0.12},
                {note: 329.63, duration: 0.12},
                {note: 293.66, duration: 0.24},
                {note: 261.63, duration: 0.24},
            ];
            
            let time = 0;
            bossMelody.forEach(({note, duration}) => {
                setTimeout(() => {
                    playNote(note, duration, 'sawtooth', 0.15);
                    playNote(note/2, duration, 'square', 0.08);
                }, time * 1000);
                time += duration;
            });
            
            setTimeout(() => {
                bossMusicPlaying = false;
                if (gameStarted && !paused && boss && !boss.defeated) playBossMusic();
            }, (time + 0.2) * 1000);
        }

        const sounds = {
            jump: () => { 
                playNote(500, 0.08, 'sine', 0.25); 
                setTimeout(() => playNote(650, 0.08, 'sine', 0.2), 40);
                playNote(200, 0.06, 'sawtooth', 0.12);
            },
            doubleJump: () => {
                playNote(700, 0.08, 'sine', 0.25); 
                setTimeout(() => playNote(900, 0.08, 'sine', 0.2), 40);
            },
            collect: () => { 
                playNote(900, 0.1, 'square', 0.25); 
                setTimeout(() => playNote(1200, 0.12, 'square', 0.25), 50);
                setTimeout(() => playNote(1500, 0.08, 'sine', 0.18), 100);
            },
            hit: () => { 
                playNote(120, 0.3, 'sawtooth', 0.3); 
                playNote(100, 0.35, 'sawtooth', 0.25);
                setTimeout(() => playNote(80, 0.2, 'sawtooth', 0.2), 100);
            },
            powerup: () => {
                const notes = [523.25, 659.25, 783.99, 1046.5];
                notes.forEach((note, i) => {
                    setTimeout(() => playNote(note, 0.12, 'sine', 0.2), i * 60);
                });
            },
            powerReady: () => {
                playNote(880, 0.08, 'sine', 0.18);
                setTimeout(() => playNote(1100, 0.08, 'sine', 0.18), 50);
            },
            dash: () => {
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => playNote(800 + i * 200, 0.04, 'square', 0.12), i * 30);
                }
            },
            groundPound: () => {
                playNote(150, 0.2, 'sawtooth', 0.28);
                setTimeout(() => playNote(100, 0.3, 'sawtooth', 0.28), 100);
            },
            shield: () => {
                playNote(600, 0.15, 'sine', 0.2);
                setTimeout(() => playNote(800, 0.15, 'sine', 0.2), 100);
            },
            bossHit: () => {
                playNote(200, 0.15, 'sawtooth', 0.32);
                setTimeout(() => playNote(150, 0.2, 'sawtooth', 0.28), 80);
            },
            bossDefeat: () => {
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => playNote(1200 - i * 150, 0.1, 'square', 0.2), i * 100);
                }
            },
            shop: () => {
                playNote(600, 0.1, 'sine', 0.18);
                setTimeout(() => playNote(800, 0.1, 'sine', 0.18), 80);
                setTimeout(() => playNote(1000, 0.15, 'sine', 0.2), 160);
            },
            mission: () => {
                playNote(1000, 0.15, 'square', 0.2);
                setTimeout(() => playNote(1200, 0.15, 'square', 0.2), 100);
            },
            charAlert: () => {
                playNote(1500, 0.1, 'sine', 0.22);
                setTimeout(() => playNote(1800, 0.1, 'sine', 0.22), 80);
            }
        };

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            document.querySelector('#controls .controlBtn').textContent = audioEnabled ? 'üîä' : 'üîá';
            if (audioEnabled && gameStarted && !paused) {
                if (boss && !boss.defeated) playBossMusic();
                else playBGM();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GAME STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let gameStarted = false;
        let paused = false;
        let gameOver = false;
        let score = 0;
        let highScore = localStorage.getItem('wonderPopHighScore') || 0;
        let frame = 0;
        let gameSpeed = 0.7;
        let combo = 0;
        let comboTimer = 0;

        let screenShake = 0;
        let cameraOffsetX = 0;
        let cameraOffsetY = 0;

        const groundY = 600;
        let player = {
            x: 80,
            y: groundY,
            width: 55,
            height: 70,
            vy: 0,
            jumping: false,
            canDoubleJump: false,
            hasDoubleJumped: false,
            runFrame: 0,
            invincible: 0,
            lives: 3,
            maxLives: 3,
            chefMode: 0,
            trail: [],
            powerCharge: 0,
            powerActive: false,
            powerTimer: 0,
            dashActive: false,
            shieldActive: false,
            isPounding: false
        };

        let obstacles = [];
        let collectibles = [];
        let specialChars = [];
        let particles = [];
        let floatingTexts = [];
        let shopIcon = null;

        let buildings = [];
        let clouds = [];
        let stars = [];
        let birds = [];

        let showTutorial = true;
        let tutorialAlpha = 1;
        let nextShopScore = 1000;
        
        let lastSpecialSpawn = 0;
        let specialSpawnCooldown = 900;

        let boss = null;
        let bossSpawned = false;
        let bossDefeated = false;
        let bossProjectiles = [];

        // ‚úÖ SISTEMA DE MISIONES
        let missions = [
            { id: 1, desc: 'Recolect√° 30 comidas', progress: 0, target: 30, complete: false, type: 'collect' },
            { id: 2, desc: 'Encontr√° a Ivancito', progress: 0, target: 1, complete: false, type: 'ivancito' },
            { id: 3, desc: 'Activ√° a Luisito', progress: 0, target: 1, complete: false, type: 'luisito' },
            { id: 4, desc: 'Consegu√≠ Chef Power', progress: 0, target: 1, complete: false, type: 'chef' },
            { id: 5, desc: 'Lleg√° a 3000 puntos', progress: 0, target: 3000, complete: false, type: 'score' }
        ];
        let currentMission = 0;
        let allMissionsComplete = false;

        // ‚úÖ ALERTS
        let charAlert = null;

        function showCharacterSelect() {
            document.getElementById('splashScreen').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('characterScreen').classList.add('show');
            }, 800);
        }

        function selectCharacter(index) {
            selectedCharIndex = index;
            selectedChar = characters[index];
            
            document.querySelectorAll('.characterCard').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            
            document.getElementById('playBtn').classList.remove('disabled');
        }

        function showIntro() {
            if (selectedCharIndex === -1) return;
            
            initAudio();
            playIntroMusic();
            
            document.getElementById('characterScreen').classList.remove('show');
            document.getElementById('introScreen').classList.add('show');
        }

        function startGameWithChar() {
            if (selectedCharIndex === -1) return;
            
            document.getElementById('introScreen').classList.remove('show');
            document.getElementById('controls').style.display = 'flex';
            
            player.lives = Math.floor(3 * selectedChar.defense);
            player.maxLives = player.lives;
            
            if (selectedChar.powerType === 'doubleJump') {
                player.canDoubleJump = true;
            }
            
            introMusicPlaying = false;
            gameStarted = true;
            playBGM();
            initGame();
            gameLoop();
        }

        function openShop() {
            paused = true;
            document.getElementById('shopPointsValue').textContent = score;
            document.getElementById('shopScreen').classList.add('show');
            sounds.shop();
        }

        function closeShop() {
            paused = false;
            document.getElementById('shopScreen').classList.remove('show');
            if (gameStarted && !gameOver) {
                if (boss && !boss.defeated) playBossMusic();
                else playBGM();
                gameLoop();
            }
        }

        function buyItem(type) {
            const prices = { life: 300, shield: 400, magnet: 350, slow: 300 };
            const price = prices[type];
            
            if (score < price) {
                createFloatingText(canvas.width/2 - 80, 400, '¬°SIN PUNTOS!', colors.red, 3000);
                sounds.hit();
                return;
            }
            
            score -= price;
            document.getElementById('shopPointsValue').textContent = score;
            sounds.powerup();
            
            if (type === 'life') {
                player.lives = Math.min(player.lives + 1, player.maxLives);
                createFloatingText(canvas.width/2 - 60, 400, '+1 VIDA!', colors.lime, 3000);
                createExplosion(canvas.width/2, 400, colors.lime, 20);
            } else if (type === 'shield') {
                player.invincible = 300;
                createFloatingText(canvas.width/2 - 70, 400, 'ESCUDO!', colors.cyan, 3000);
                createExplosion(canvas.width/2, 400, colors.cyan, 20);
            } else if (type === 'magnet') {
                collectibles.forEach(col => {
                    if (Math.abs(col.x - player.x) < 400) {
                        score += col.points;
                        createExplosion(col.x, col.y, colors.lime, 15);
                    }
                });
                collectibles = [];
                createFloatingText(canvas.width/2 - 60, 400, 'IM√ÅN!', colors.yellow, 3000);
            } else if (type === 'slow') {
                gameSpeed *= 0.5;
                setTimeout(() => { gameSpeed *= 2; }, 3000);
                createFloatingText(canvas.width/2 - 80, 400, 'SLOW-MO!', colors.purple, 3000);
            }
        }

        function retry() {
            location.reload();
        }

        function initGame() {
            for (let i = 0; i < 8; i++) {
                buildings.push({
                    x: i * 120,
                    y: 200 + Math.random() * 100,
                    width: 80 + Math.random() * 40,
                    height: 150 + Math.random() * 100,
                    speed: 0.2,
                    color: Math.random() > 0.5 ? colors.building : '#A0826D'
                });
            }
            
            for (let i = 0; i < 12; i++) {
                clouds.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * 250,
                    speed: 0.3 + Math.random() * 0.2,
                    size: 30 + Math.random() * 30
                });
            }
            
            for (let i = 0; i < 40; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * 300,
                    size: 1 + Math.random() * 2,
                    twinkle: Math.random() * 60
                });
            }

            for (let i = 0; i < 5; i++) {
                birds.push({
                    x: Math.random() * canvas.width,
                    y: 100 + Math.random() * 150,
                    speed: 0.5 + Math.random() * 0.3,
                    wingFrame: Math.random() * 10
                });
            }
        }

        canvas.addEventListener('touchstart', jump);
        canvas.addEventListener('mousedown', jump);
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') jump();
            if (e.code === 'ArrowDown' && selectedChar.powerType === 'groundPound' && player.jumping) {
                activateGroundPound();
            }
        });

        function jump() {
            if (!gameStarted || paused || gameOver) return;
            
            if (player.canDoubleJump && player.jumping && !player.hasDoubleJumped) {
                player.vy = -16 * selectedChar.jump;
                player.hasDoubleJumped = true;
                sounds.doubleJump();
                createParticles(player.x + player.width/2, player.y + player.height, colors.orange, 12);
                
                for (let i = 0; i < 3; i++) {
                    particles.push({
                        x: player.x + player.width/2,
                        y: player.y + player.height,
                        vx: (Math.random() - 0.5) * 4,
                        vy: Math.random() * 2,
                        size: 6,
                        color: colors.orange,
                        life: 25,
                        emoji: 'ü•ï'
                    });
                }
                return;
            }
            
            if (!player.jumping) {
                player.vy = -16 * selectedChar.jump;
                player.jumping = true;
                player.hasDoubleJumped = false;
                sounds.jump();
                createParticles(player.x + player.width/2, player.y + player.height, colors.yellow, 8);
            }
        }

        function activateGroundPound() {
            if (selectedChar.powerType !== 'groundPound' || player.isPounding) return;
            
            player.isPounding = true;
            player.vy = 25;
            sounds.groundPound();
            
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x: player.x + player.width/2,
                    y: player.y + player.height,
                    vx: (Math.random() - 0.5) * 8,
                    vy: -Math.random() * 5,
                    size: 8,
                    color: colors.purple,
                    life: 30
                });
            }
        }

        function spawnObstacle() {
            if (frame < 420 || boss) return;
            
            obstacles.push({
                x: canvas.width + 50,
                y: groundY + player.height - 50,
                width: 45,
                height: 50,
                pulseFrame: 0
            });
        }

        function spawnCollectible() {
            if (frame < 300 || boss) return;
            
            const emojis = ['üçï', 'üçî', 'üåÆ', 'üçú', 'üç∞', 'üç©', 'ü•ó', 'üßà'];
            
            collectibles.push({
                x: canvas.width + 50,
                y: 250 + Math.random() * 250,
                width: 45,
                height: 45,
                emoji: emojis[Math.floor(Math.random() * emojis.length)],
                floatOffset: Math.random() * Math.PI * 2,
                points: 100
            });
        }

        function spawnShop() {
            if (score >= nextShopScore && !shopIcon && !boss) {
                shopIcon = {
                    x: canvas.width + 50,
                    y: 300,
                    width: 60,
                    height: 60,
                    floatOffset: 0
                };
                nextShopScore += 1000;
            }
        }

        function spawnSpecialChar() {
            if (frame < 1200 || boss) return;
            if (specialChars.length > 0) return;
            if (frame - lastSpecialSpawn < specialSpawnCooldown) return;
            
            if (Math.random() > 0.005) return;
            
            lastSpecialSpawn = frame;
            specialSpawnCooldown = 900 + Math.random() * 600;
            
            const types = ['chef', 'ivancito', 'luisito'];
            const weights = [0.3, 0.4, 0.3];
            const rand = Math.random();
            let type;
            
            if (rand < weights[0]) type = 'chef';
            else if (rand < weights[0] + weights[1]) type = 'ivancito';
            else type = 'luisito';
            
            // ‚úÖ ALERT cuando aparece personaje
            showCharAlert(type);
            
            if (type === 'chef') {
                specialChars.push({
                    type: 'chef',
                    x: canvas.width + 50,
                    y: 250,
                    width: 60,
                    height: 80,
                    floatOffset: 0
                });
            } else if (type === 'ivancito') {
                specialChars.push({
                    type: 'ivancito',
                    x: canvas.width + 50,
                    y: groundY,
                    width: 50,
                    height: 65,
                    runFrame: 0,
                    photosTaken: 0,
                    photoTimer: 0,
                    lifeTime: 0
                });
            } else {
                specialChars.push({
                    type: 'luisito',
                    x: canvas.width + 50,
                    y: 350,
                    width: 55,
                    height: 70,
                    floatOffset: 0,
                    activated: false
                });
            }
        }

        // ‚úÖ MOSTRAR ALERTA DE PERSONAJE
        function showCharAlert(type) {
            const names = {
                'chef': '¬°EL CHEF APARECI√ì! ‚Üí',
                'ivancito': '¬°IVANCITO EST√Å AQU√ç! ‚Üí',
                'luisito': '¬°LUISITO LLEG√ì! ‚Üí'
            };
            
            charAlert = {
                text: names[type],
                life: 90,
                y: 250
            };
            
            sounds.charAlert();
        }

        function spawnBoss() {
            if (bossSpawned || !allMissionsComplete) return;
            
            bossSpawned = true;
            
            obstacles = [];
            collectibles = [];
            specialChars = [];
            shopIcon = null;
            
            boss = {
                x: canvas.width - 150,
                y: groundY - 20,
                width: 90,
                height: 110,
                hp: 10,
                maxHp: 10,
                phase: 1,
                attackTimer: 0,
                moveDir: -1,
                speed: 2,
                invincible: 0,
                defeated: false
            };
            
            bgmPlaying = false;
            playBossMusic();
            
            screenShake = 30;
            createFloatingText(canvas.width/2 - 140, 200, '¬°BOSS BATTLE!', colors.red, 4000, 64);
            createFloatingText(canvas.width/2 - 160, 260, 'RONALD MCDONALD', colors.yellow, 4000, 56);
        }

        function update() {
            if (gameOver || paused) return;
            
            frame++;
            
            checkMissions();
            
            if (allMissionsComplete && !bossSpawned) {
                spawnBoss();
            }
            
            if (screenShake > 0) {
                screenShake *= 0.9;
                cameraOffsetX = (Math.random() - 0.5) * screenShake;
                cameraOffsetY = (Math.random() - 0.5) * screenShake;
            } else {
                cameraOffsetX = 0;
                cameraOffsetY = 0;
            }
            
            if (selectedChar.powerCooldown > 0 && !player.powerActive) {
                player.powerCharge++;
                if (player.powerCharge >= selectedChar.powerCooldown) {
                    if (player.powerCharge === selectedChar.powerCooldown) {
                        sounds.powerReady();
                        createFloatingText(player.x - 20, player.y - 40, 'POWER READY!', colors.yellow, 2000);
                    }
                    
                    if (selectedChar.powerType === 'shield') {
                        activateShield();
                    } else if (selectedChar.powerType === 'dash') {
                        activateDash();
                    }
                }
            }
            
            if (player.powerActive) {
                player.powerTimer--;
                if (player.powerTimer <= 0) {
                    player.powerActive = false;
                    player.powerCharge = 0;
                    player.shieldActive = false;
                    player.dashActive = false;
                }
            }
            
            player.vy += 0.7;
            player.y += player.vy;
            
            if (player.y >= groundY) {
                player.y = groundY;
                player.vy = 0;
                player.jumping = false;
                player.hasDoubleJumped = false;
                
                if (player.isPounding) {
                    player.isPounding = false;
                    screenShake = 15;
                    
                    obstacles.forEach((obs, i) => {
                        if (Math.abs(obs.x - player.x) < 120) {
                            obstacles.splice(i, 1);
                            score += 50;
                            createExplosion(obs.x, obs.y, colors.purple, 20);
                            createFloatingText(obs.x, obs.y - 30, '+50', colors.yellow, 2000);
                        }
                    });
                    
                    for (let i = 0; i < 20; i++) {
                        particles.push({
                            x: player.x + player.width/2,
                            y: player.y + player.height,
                            vx: (Math.random() - 0.5) * 15,
                            vy: -Math.random() * 10,
                            size: 4 + Math.random() * 6,
                            color: colors.purple,
                            life: 40
                        });
                    }
                }
            }
            
            if (!player.jumping) {
                player.runFrame += 0.25;
            }
            
            if (player.dashActive && gameSpeed > 1.5) {
                player.trail.push({
                    x: player.x,
                    y: player.y,
                    alpha: 0.6,
                    life: 12
                });
            }
            player.trail.forEach((t, i) => {
                t.life--;
                t.alpha *= 0.9;
                if (t.life <= 0) player.trail.splice(i, 1);
            });
            
            if (player.invincible > 0) player.invincible--;
            if (player.chefMode > 0) player.chefMode--;
            
            if (comboTimer > 0) {
                comboTimer--;
                if (comboTimer === 0) combo = 0;
            }
            
            if (showTutorial && frame > 300) {
                tutorialAlpha -= 0.01;
                if (tutorialAlpha <= 0) showTutorial = false;
            }
            
            // ‚úÖ Update char alert
            if (charAlert) {
                charAlert.life--;
                if (charAlert.life <= 0) charAlert = null;
            }
            
            buildings.forEach(b => {
                b.x -= b.speed * gameSpeed;
                if (b.x + b.width < 0) b.x = canvas.width + Math.random() * 200;
            });
            
            clouds.forEach(c => {
                c.x -= c.speed * gameSpeed;
                if (c.x < -c.size) c.x = canvas.width + c.size;
            });
            
            stars.forEach(s => s.twinkle = (s.twinkle + 1) % 120);

            birds.forEach(b => {
                b.x -= b.speed * gameSpeed;
                b.wingFrame += 0.3;
                if (b.x < -20) b.x = canvas.width + 20;
            });
            
            if (boss) {
                updateBoss();
            } else {
                const obstacleInterval = frame < 300 ? 150 : 120;
                if (frame % obstacleInterval === 0) spawnObstacle();
                if (frame % 130 === 0) spawnCollectible();
                
                spawnShop();
                spawnSpecialChar();
            }
            
            obstacles.forEach((obs, index) => {
                obs.x -= gameSpeed * 3.5 * selectedChar.speed;
                obs.pulseFrame += 0.15;
                
                if (player.shieldActive &&
                    player.x < obs.x + obs.width &&
                    player.x + player.width > obs.x &&
                    player.y + player.height > obs.y &&
                    player.y < obs.y + obs.height) {
                    obstacles.splice(index, 1);
                    score += 50;
                    createExplosion(obs.x, obs.y, colors.red, 15);
                    createFloatingText(obs.x, obs.y - 30, '+50', colors.yellow, 2000);
                    return;
                }
                
                if (!player.invincible && !player.chefMode && !player.shieldActive &&
                    player.x < obs.x + obs.width &&
                    player.x + player.width > obs.x &&
                    player.y + player.height > obs.y &&
                    player.y < obs.y + obs.height) {
                    hitObstacle();
                }
                
                if (obs.x < -obs.width) {
                    obstacles.splice(index, 1);
                    score += 10;
                }
            });
            
            collectibles.forEach((col, index) => {
                col.x -= gameSpeed * 3.5 * selectedChar.speed;
                col.floatOffset += 0.1;
                
                if (player.dashActive) {
                    const dx = player.x - col.x;
                    const dy = player.y - col.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < 150) {
                        col.x += dx * 0.15;
                        col.y += dy * 0.15;
                    }
                }
                
                if (player.x < col.x + col.width &&
                    player.x + player.width > col.x &&
                    player.y < col.y + col.height &&
                    player.y + player.height > col.y) {
                    collectItem(col, index);
                }
                
                if (col.x < -col.width) {
                    collectibles.splice(index, 1);
                }
            });
            
            if (shopIcon) {
                shopIcon.x -= gameSpeed * 2.5;
                shopIcon.floatOffset += 0.12;
                
                if (player.x < shopIcon.x + shopIcon.width &&
                    player.x + player.width > shopIcon.x &&
                    player.y < shopIcon.y + shopIcon.height &&
                    player.y + player.height > shopIcon.y) {
                    shopIcon = null;
                    openShop();
                }
                
                if (shopIcon && shopIcon.x < -shopIcon.width) {
                    shopIcon = null;
                }
            }
            
            specialChars.forEach((sc, index) => {
                if (sc.type === 'chef') {
                    sc.x -= gameSpeed * 1.5;
                    sc.floatOffset += 0.15;
                    
                    if (player.x < sc.x + sc.width &&
                        player.x + player.width > sc.x &&
                        player.y < sc.y + sc.height &&
                        player.y + player.height > sc.y) {
                        activateChef();
                        specialChars.splice(index, 1);
                    }
                    
                    if (sc.x < -sc.width) specialChars.splice(index, 1);
                    
                } else if (sc.type === 'ivancito') {
                    sc.x -= gameSpeed * 3.5 * selectedChar.speed;
                    sc.runFrame += 0.3;
                    sc.lifeTime++;
                    
                    if (sc.lifeTime > 480) {
                        specialChars.splice(index, 1);
                        return;
                    }
                    
                    const distance = Math.abs(sc.x - player.x);
                    if (distance < 100 && sc.photosTaken < 3) {
                        sc.photoTimer++;
                        if (sc.photoTimer >= 30) {
                            takePhoto(sc);
                            sc.photosTaken++;
                            sc.photoTimer = 0;
                        }
                    }
                    
                    if (sc.photosTaken >= 3 || sc.x < -sc.width) {
                        specialChars.splice(index, 1);
                    }
                    
                } else if (sc.type === 'luisito') {
                    sc.x -= gameSpeed * 1.5;
                    sc.floatOffset += 0.1;
                    
                    const distance = player.x - sc.x;
                    if (!sc.activated && distance > -30 && distance < 30) {
                        activateLuisito(sc);
                        sc.activated = true;
                    }
                    
                    if (sc.x < -200) specialChars.splice(index, 1);
                }
            });
            
            particles.forEach((p, index) => {
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.96;
                p.vy *= 0.96;
                p.life--;
                if (p.life <= 0) particles.splice(index, 1);
            });
            
            floatingTexts.forEach((ft, index) => {
                ft.y += ft.vy;
                ft.life--;
                if (ft.life <= 0) floatingTexts.splice(index, 1);
            });
            
            if (frame % 1200 === 0 && gameSpeed < 2.5 && !boss) {
                gameSpeed += 0.1;
            }
        }

        function checkMissions() {
            missions.forEach(mission => {
                if (mission.complete) return;
                
                if (mission.type === 'score') {
                    mission.progress = score;
                    if (score >= mission.target && !mission.complete) {
                        completeMission(mission);
                    }
                }
            });
            
            const allComplete = missions.every(m => m.complete);
            if (allComplete && !allMissionsComplete) {
                allMissionsComplete = true;
                sounds.mission();
                createFloatingText(canvas.width/2 - 180, 300, '¬°TODAS LAS MISIONES COMPLETAS!', colors.lime, 4000, 48);
                createFloatingText(canvas.width/2 - 140, 350, '¬°PREP√ÅRATE PARA EL BOSS!', colors.red, 4000, 42);
            }
        }

        function completeMission(mission) {
            mission.complete = true;
            currentMission = Math.min(currentMission + 1, missions.length - 1);
            sounds.mission();
            
            // ‚úÖ Efecto visual cuando complet√°s misi√≥n
            screenShake = 20;
            createFloatingText(canvas.width/2 - 160, 250, '¬°MISI√ìN COMPLETA!', colors.yellow, 3500, 52);
            
            for (let i = 0; i < 30; i++) {
                particles.push({
                    x: canvas.width/2,
                    y: 280,
                    vx: (Math.random() - 0.5) * 12,
                    vy: (Math.random() - 0.5) * 12,
                    size: 4 + Math.random() * 6,
                    color: [colors.yellow, colors.lime, colors.cyan][Math.floor(Math.random() * 3)],
                    life: 60
                });
            }
        }

        function updateBoss() {
            if (!boss || boss.defeated) return;
            
            boss.invincible = Math.max(0, boss.invincible - 1);
            boss.attackTimer++;
            
            boss.x += boss.moveDir * boss.speed;
            if (boss.x < 50 || boss.x > canvas.width - 150) {
                boss.moveDir *= -1;
            }
            
            if (boss.hp <= 6 && boss.phase === 1) {
                boss.phase = 2;
                boss.speed = 3;
                screenShake = 20;
                createFloatingText(canvas.width/2 - 80, 200, 'PHASE 2!', colors.red, 3000, 56);
            }
            if (boss.hp <= 3 && boss.phase === 2) {
                boss.phase = 3;
                boss.speed = 4;
                screenShake = 25;
                createFloatingText(canvas.width/2 - 120, 200, 'FINAL PHASE!', colors.red, 3000, 56);
            }
            
            if (boss.attackTimer > 90 && boss.phase === 1) {
                spawnBossProjectile('bigmac');
                boss.attackTimer = 0;
            }
            if (boss.attackTimer > 70 && boss.phase === 2) {
                spawnBossProjectile('fries');
                boss.attackTimer = 0;
            }
            if (boss.attackTimer > 50 && boss.phase === 3) {
                spawnBossProjectile('happymeal');
                boss.attackTimer = 0;
            }
            
            bossProjectiles.forEach((proj, i) => {
                proj.x -= 6;
                proj.floatOffset += 0.15;
                
                if (!player.invincible && !player.shieldActive &&
                    player.x < proj.x + proj.width &&
                    player.x + player.width > proj.x &&
                    player.y < proj.y + proj.height &&
                    player.y + player.height > proj.y) {
                    hitObstacle();
                    bossProjectiles.splice(i, 1);
                }
                
                if (proj.x < -50) bossProjectiles.splice(i, 1);
            });
            
            if (!boss.invincible && player.vy > 0 &&
                player.x < boss.x + boss.width &&
                player.x + player.width > boss.x &&
                player.y + player.height > boss.y &&
                player.y + player.height < boss.y + 40) {
                
                hitBoss();
                player.vy = -12;
            }
        }

        function spawnBossProjectile(type) {
            const proj = {
                x: boss.x,
                y: boss.y + boss.height/2,
                width: 40,
                height: 40,
                type: type,
                floatOffset: 0
            };
            
            if (type === 'bigmac') {
                proj.emoji = 'üçî';
            } else if (type === 'fries') {
                proj.emoji = 'üçü';
            } else if (type === 'happymeal') {
                proj.emoji = 'üì¶';
            }
            
            bossProjectiles.push(proj);
        }

        function hitBoss() {
            boss.hp--;
            boss.invincible = 30;
            screenShake = 12;
            
            sounds.bossHit();
            createExplosion(player.x + player.width/2, boss.y + 20, colors.red, 25);
            createFloatingText(boss.x + 20, boss.y - 30, '-1 HP', colors.red, 2500);
            score += 200;
            
            if (boss.hp <= 0) {
                defeatBoss();
            }
        }

        function defeatBoss() {
            boss.defeated = true;
            bossDefeated = true;
            
            screenShake = 30;
            sounds.bossDefeat();
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    createExplosion(
                        boss.x + Math.random() * boss.width,
                        boss.y + Math.random() * boss.height,
                        [colors.red, colors.orange, colors.yellow][Math.floor(Math.random() * 3)],
                        15
                    );
                }, i * 50);
            }
            
            score += 2000;
            createFloatingText(canvas.width/2 - 180, 250, '¬°BOSS DERROTADO!', colors.yellow, 4500, 64);
            createFloatingText(canvas.width/2 - 140, 310, '+2000 PUNTOS', colors.cyan, 4000, 52);
            
            setTimeout(() => {
                boss = null;
                gameSpeed *= 2;
                bossMusicPlaying = false;
                playBGM();
                createFloatingText(canvas.width/2 - 140, 350, '¬°MODO TURBO! x2', colors.pink, 4000, 48);
            }, 2500);
        }

        function activateShield() {
            player.powerActive = true;
            player.shieldActive = true;
            player.powerTimer = selectedChar.powerDuration;
            sounds.shield();
            
            createFloatingText(player.x - 30, player.y - 40, 'SALSA SHIELD!', colors.red, 3000);
            createExplosion(player.x + player.width/2, player.y + player.height/2, colors.red, 20);
        }

        function activateDash() {
            player.powerActive = true;
            player.dashActive = true;
            player.powerTimer = selectedChar.powerDuration;
            sounds.dash();
            
            createFloatingText(player.x - 30, player.y - 40, 'AVOCADO DASH!', colors.green, 3000);
            
            const originalSpeed = gameSpeed;
            gameSpeed *= 2;
            setTimeout(() => {
                if (gameSpeed === originalSpeed * 2) {
                    gameSpeed = originalSpeed;
                }
            }, selectedChar.powerDuration * 16.67);
        }

        function hitObstacle() {
            player.lives--;
            player.invincible = 120;
            combo = 0;
            comboTimer = 0;
            
            screenShake = 15;
            
            sounds.hit();
            createExplosion(player.x + player.width/2, player.y + player.height/2, colors.red, 25);
            createFloatingText(player.x, player.y - 30, '-1 VIDA', colors.red, 2500);
            
            if (player.lives <= 0) endGame();
        }

        function collectItem(col, index) {
            combo++;
            comboTimer = 180;
            
            let points = col.points;
            if (player.chefMode > 0) points *= 3;
            if (player.dashActive) points *= 2;
            points *= combo;
            score += points;
            
            const mission1 = missions.find(m => m.id === 1);
            if (mission1 && !mission1.complete) {
                mission1.progress++;
                if (mission1.progress >= mission1.target) {
                    completeMission(mission1);
                }
            }
            
            sounds.collect();
            collectibles.splice(index, 1);
            
            createExplosion(col.x, col.y, colors.lime, 18);
            createFloatingText(col.x, col.y - 20, `+${points}${combo > 1 ? ' x'+combo : ''}`, colors.yellow, 2000);
        }

        function activateChef() {
            player.chefMode = 600;
            player.invincible = 600;
            
            screenShake = 20;
            
            sounds.powerup();
            createFloatingText(canvas.width/2 - 160, 200, '¬°COCINA POP POWER!', colors.yellow, 4000, 52);
            createExplosion(player.x + player.width/2, player.y + player.height/2, colors.yellow, 30);
            
            const mission4 = missions.find(m => m.id === 4);
            if (mission4 && !mission4.complete) {
                mission4.progress = 1;
                completeMission(mission4);
            }
        }

        function takePhoto(ivancito) {
            screenShake = 8;
            
            sounds.powerup();
            score += 150;
            
            createFloatingText(ivancito.x - 30, ivancito.y - 50, '¬°DIVINA!', colors.pink, 3500, 56);
            createFloatingText(ivancito.x + 30, ivancito.y - 90, '+150', colors.yellow, 3000, 48);
            createExplosion(ivancito.x, ivancito.y, colors.pink, 15);
            
            const mission2 = missions.find(m => m.id === 2);
            if (mission2 && !mission2.complete && ivancito.photosTaken === 2) {
                mission2.progress = 1;
                completeMission(mission2);
            }
        }

        function activateLuisito(luisito) {
            sounds.powerup();
            
            createFloatingText(luisito.x - 50, luisito.y - 60, '¬°ZARLANGAS', colors.cyan, 4000, 58);
            createFloatingText(luisito.x - 30, luisito.y - 100, 'MA√ëANAS!', colors.cyan, 4000, 58);
            
            const mission3 = missions.find(m => m.id === 3);
            if (mission3 && !mission3.complete) {
                mission3.progress = 1;
                completeMission(mission3);
            }
            
            const rewards = [
                { type: 'points', value: 200 },
                { type: 'life', value: 1 },
                { type: 'shield', value: 150 }
            ];
            
            for (let i = 0; i < 3; i++) {
                const reward = rewards[Math.floor(Math.random() * rewards.length)];
                setTimeout(() => {
                    if (reward.type === 'points') {
                        score += reward.value;
                        createFloatingText(luisito.x + i * 40, luisito.y - 120 - i * 30, `+${reward.value}`, colors.yellow, 3000, 48);
                    } else if (reward.type === 'life') {
                        player.lives = Math.min(player.lives + 1, player.maxLives);
                        createFloatingText(luisito.x + i * 40, luisito.y - 120 - i * 30, '+1 ‚ù§Ô∏è', colors.red, 3000, 48);
                    } else {
                        player.invincible = reward.value;
                        createFloatingText(luisito.x + i * 40, luisito.y - 120 - i * 30, 'üõ°Ô∏è', colors.cyan, 3000, 48);
                    }
                    createExplosion(luisito.x + i * 40, luisito.y - 120 - i * 30, colors.cyan, 15);
                }, i * 250);
            }
        }

        function endGame() {
            gameOver = true;
            gameStarted = false;
            sounds.hit();
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('wonderPopHighScore', highScore);
            }
            
            document.getElementById('finalScoreValue').textContent = score;
            document.getElementById('highScoreValue').textContent = highScore;
            document.getElementById('gameOverScreen').classList.add('show');
        }

        function createExplosion(x, y, color, count = 12) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    size: 3 + Math.random() * 5,
                    color: color,
                    life: 45
                });
            }
        }

        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 7,
                    vy: (Math.random() - 0.5) * 7,
                    size: 2 + Math.random() * 4,
                    color: color,
                    life: 35
                });
            }
        }

        function createFloatingText(x, y, text, color, duration = 2000, fontSize = 48) {
            floatingTexts.push({
                x: x,
                y: y,
                vy: -1.2,
                text: text,
                color: color,
                life: Math.floor(duration / 16.67),
                fontSize: fontSize,
                scale: 1,
                scaleDir: 1
            });
        }

        function drawPlayer() {
            const x = player.x;
            const y = player.y;
            const w = player.width;
            const h = player.height;
            
            player.trail.forEach(t => {
                ctx.globalAlpha = t.alpha * 0.4;
                ctx.fillStyle = selectedChar.color;
                ctx.fillRect(t.x + 10, t.y + 30, w - 20, h - 30);
                ctx.globalAlpha = 1;
            });
            
            if (player.shieldActive) {
                const pulseSize = Math.sin(frame * 0.2) * 5;
                ctx.strokeStyle = colors.red;
                ctx.lineWidth = 5;
                ctx.globalAlpha = 0.7;
                ctx.strokeRect(x - 15 + pulseSize, y - 15 + pulseSize, w + 30 - pulseSize*2, h + 30 - pulseSize*2);
                ctx.globalAlpha = 1;
                
                for (let i = 0; i < 4; i++) {
                    const angle = (frame * 0.1 + i * Math.PI / 2);
                    const particleX = x + w/2 + Math.cos(angle) * 45;
                    const particleY = y + h/2 + Math.sin(angle) * 45;
                    ctx.fillStyle = colors.red;
                    ctx.fillRect(particleX, particleY, 6, 6);
                }
            }
            
            if (player.dashActive) {
                const rainbowColors = [colors.lime, colors.green, colors.cyan];
                for (let i = 0; i < 3; i++) {
                    const angle = (frame * 0.15 + i * Math.PI * 2 / 3);
                    const particleX = x + w/2 + Math.cos(angle) * 40;
                    const particleY = y + h/2 + Math.sin(angle) * 40;
                    ctx.fillStyle = rainbowColors[i];
                    ctx.fillRect(particleX, particleY, 5, 5);
                }
            }
            
            if (player.chefMode > 0) {
                const rainbowColors = [colors.red, colors.orange, colors.yellow, colors.lime, colors.cyan, colors.pink];
                for (let i = 0; i < 3; i++) {
                    const angle = (frame * 0.1 + i * Math.PI * 2 / 3);
                    const particleX = x + w/2 + Math.cos(angle) * 35;
                    const particleY = y + h/2 + Math.sin(angle) * 35;
                    ctx.fillStyle = rainbowColors[Math.floor(frame/5 + i) % rainbowColors.length];
                    ctx.fillRect(particleX, particleY, 4, 4);
                }
                
                ctx.fillStyle = `rgba(255, 215, 0, ${0.3 + Math.sin(frame * 0.2) * 0.2})`;
                ctx.fillRect(x - 15, y - 15, w + 30, h + 30);
            }
            
            if (player.invincible > 0 && player.chefMode === 0 && !player.shieldActive && frame % 10 < 5) {
                ctx.globalAlpha = 0.5;
            }
            
            const charColor = selectedChar.color;
            
            ctx.fillStyle = charColor;
            ctx.fillRect(x + 10, y + 30, w - 20, h - 30);
            
            ctx.strokeStyle = colors.black;
            ctx.lineWidth = 3;
            ctx.strokeRect(x + 10, y + 30, w - 20, h - 30);
            
            ctx.fillStyle = colors.white;
            ctx.fillRect(x + 16, y + 20, 8, 8);
            ctx.fillRect(x + 31, y + 20, 8, 8);
            
            ctx.fillStyle = colors.black;
            ctx.fillRect(x + 18, y + 22, 4, 4);
            ctx.fillRect(x + 33, y + 22, 4, 4);
            
            ctx.fillStyle = colors.black;
            ctx.fillRect(x + 20, y + 60, 15, 3);
            ctx.fillRect(x + 18, y + 58, 2, 2);
            ctx.fillRect(x + 35, y + 58, 2, 2);
            
            ctx.fillStyle = colors.white;
            ctx.fillRect(x + 10, y + 5, 35, 10);
            ctx.fillRect(x + 14, y - 8, 27, 13);
            ctx.strokeStyle = colors.black;
            ctx.lineWidth = 2;
            ctx.strokeRect(x + 10, y + 5, 35, 10);
            ctx.strokeRect(x + 14, y - 8, 27, 13);
            
            const armOffset = Math.floor(player.runFrame) % 2 === 0 ? 4 : -4;
            ctx.fillStyle = charColor;
            ctx.fillRect(x + 2, y + 40 + armOffset, 8, 18);
            ctx.fillRect(x + w - 10, y + 40 - armOffset, 8, 18);
            
            if (!player.jumping) {
                const legFrame = Math.floor(player.runFrame);
                ctx.fillStyle = colors.black;
                if (legFrame % 2 === 0) {
                    ctx.fillRect(x + 15, y + h, 12, 7);
                    ctx.fillRect(x + 30, y + h - 5, 12, 7);
                } else {
                    ctx.fillRect(x + 15, y + h - 5, 12, 7);
                    ctx.fillRect(x + 30, y + h, 12, 7);
                }
            } else {
                ctx.fillStyle = colors.black;
                ctx.fillRect(x + 15, y + h - 3, 12, 7);
                ctx.fillRect(x + 30, y + h - 3, 12, 7);
            }
            
            ctx.globalAlpha = 1;
        }

        function drawSpecialChar(sc) {
            if (sc.type === 'chef') {
                const floatY = sc.y + Math.sin(sc.floatOffset) * 15;
                
                ctx.fillStyle = `rgba(255, 215, 0, 0.4)`;
                ctx.fillRect(sc.x - 15, floatY - 15, sc.width + 30, sc.height + 30);
                
                ctx.fillStyle = colors.orange;
                ctx.fillRect(sc.x + 5, floatY + 30, sc.width - 10, sc.height - 30);
                
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 3;
                ctx.strokeRect(sc.x + 5, floatY + 30, sc.width - 10, sc.height - 30);
                
                ctx.fillStyle = colors.white;
                ctx.fillRect(sc.x + 12, floatY + 20, 10, 10);
                ctx.fillRect(sc.x + 30, floatY + 20, 10, 10);
                
                ctx.fillStyle = colors.black;
                ctx.fillRect(sc.x + 15, floatY + 23, 4, 4);
                ctx.fillRect(sc.x + 33, floatY + 23, 4, 4);
                
                ctx.fillStyle = colors.white;
                ctx.fillRect(sc.x, floatY - 5, sc.width, 15);
                ctx.fillRect(sc.x + 5, floatY - 25, sc.width - 10, 20);
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 3;
                ctx.strokeRect(sc.x, floatY - 5, sc.width, 15);
                ctx.strokeRect(sc.x + 5, floatY - 25, sc.width - 10, 20);
                
                ctx.font = 'bold 12px Courier';
                ctx.fillStyle = colors.yellow;
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 3;
                ctx.strokeText('EL CHEF', sc.x - 10, floatY - 30);
                ctx.fillText('EL CHEF', sc.x - 10, floatY - 30);
                
            } else if (sc.type === 'ivancito') {
                ctx.fillStyle = colors.pink;
                ctx.fillRect(sc.x + 5, sc.y + 25, sc.width - 10, sc.height - 25);
                
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 3;
                ctx.strokeRect(sc.x + 5, sc.y + 25, sc.width - 10, sc.height - 25);
                
                ctx.fillStyle = '#FFD9B3';
                ctx.fillRect(sc.x + 10, sc.y + 10, 30, 25);
                
                ctx.fillStyle = colors.black;
                ctx.fillRect(sc.x + 14, sc.y + 17, 6, 6);
                ctx.fillRect(sc.x + 28, sc.y + 17, 6, 6);
                
                ctx.fillRect(sc.x + 18, sc.y + 27, 14, 2);
                ctx.fillRect(sc.x + 16, sc.y + 26, 2, 2);
                ctx.fillRect(sc.x + 32, sc.y + 26, 2, 2);
                
                ctx.fillStyle = colors.black;
                ctx.fillRect(sc.x + 12, sc.y + 40, 26, 18);
                ctx.fillStyle = colors.white;
                ctx.fillRect(sc.x + 18, sc.y + 44, 14, 10);
                ctx.fillStyle = colors.blue;
                ctx.fillRect(sc.x + 22, sc.y + 47, 6, 4);
                
                if (sc.photoTimer > 25) {
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.6)';
                    ctx.fillRect(sc.x - 10, sc.y - 10, sc.width + 20, sc.height + 20);
                }
                
                const legFrame = Math.floor(sc.runFrame);
                ctx.fillStyle = colors.black;
                if (legFrame % 2 === 0) {
                    ctx.fillRect(sc.x + 12, sc.y + sc.height, 10, 6);
                    ctx.fillRect(sc.x + 25, sc.y + sc.height - 4, 10, 6);
                } else {
                    ctx.fillRect(sc.x + 12, sc.y + sc.height - 4, 10, 6);
                    ctx.fillRect(sc.x + 25, sc.y + sc.height, 10, 6);
                }
                
                ctx.font = 'bold 11px Courier';
                ctx.fillStyle = colors.pink;
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 3;
                ctx.strokeText('IVANCITO', sc.x - 10, sc.y - 10);
                ctx.fillText('IVANCITO', sc.x - 10, sc.y - 10);
                
            } else if (sc.type === 'luisito') {
                const floatY = sc.y + Math.sin(sc.floatOffset) * 8;
                
                ctx.fillStyle = colors.brown;
                ctx.fillRect(sc.x + 10, floatY + 40, 35, 10);
                ctx.fillRect(sc.x + 10, floatY + 50, 5, 20);
                ctx.fillRect(sc.x + 40, floatY + 50, 5, 20);
                
                ctx.fillStyle = colors.black;
                ctx.fillRect(sc.x + 8, floatY + 25, sc.width - 16, sc.height - 35);
                
                ctx.strokeStyle = colors.white;
                ctx.lineWidth = 2;
                ctx.strokeRect(sc.x + 8, floatY + 25, sc.width - 16, sc.height - 35);
                
                ctx.fillStyle = '#FFD9B3';
                ctx.fillRect(sc.x + 15, floatY + 10, 25, 20);
                
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 2;
                ctx.strokeRect(sc.x + 16, floatY + 15, 10, 8);
                ctx.strokeRect(sc.x + 29, floatY + 15, 10, 8);
                ctx.beginPath();
                ctx.moveTo(sc.x + 26, floatY + 19);
                ctx.lineTo(sc.x + 29, floatY + 19);
                ctx.stroke();
                
                ctx.fillStyle = colors.black;
                ctx.fillRect(sc.x + 10, floatY, 35, 8);
                ctx.fillRect(sc.x + 15, floatY - 10, 25, 10);
                
                ctx.strokeStyle = colors.white;
                ctx.lineWidth = 1;
                ctx.strokeRect(sc.x + 10, floatY, 35, 2);
                
                ctx.font = 'bold 11px Courier';
                ctx.fillStyle = colors.cyan;
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 3;
                ctx.strokeText('LUISITO', sc.x - 5, floatY - 15);
                ctx.fillText('LUISITO', sc.x - 5, floatY - 15);
            }
        }

        function drawBoss() {
            if (!boss || boss.defeated) return;
            
            const x = boss.x;
            const y = boss.y;
            const w = boss.width;
            const h = boss.height;
            
            const pulse = Math.sin(frame * 0.15) * 0.3 + 0.7;
            ctx.fillStyle = `rgba(255, 0, 0, ${pulse * 0.4})`;
            ctx.fillRect(x - 20, y - 20, w + 40, h + 40);
            
            if (boss.invincible > 0 && frame % 8 < 4) {
                ctx.globalAlpha = 0.5;
            }
            
            ctx.fillStyle = colors.red;
            ctx.fillRect(x + 10, y + 40, w - 20, h - 40);
            
            ctx.fillStyle = colors.yellow;
            ctx.fillRect(x + 15, y + 50, w - 30, 8);
            ctx.fillRect(x + 15, y + 65, w - 30, 8);
            ctx.fillRect(x + 15, y + 80, w - 30, 8);
            
            ctx.strokeStyle = colors.black;
            ctx.lineWidth = 4;
            ctx.strokeRect(x + 10, y + 40, w - 20, h - 40);
            
            ctx.fillStyle = colors.white;
            ctx.fillRect(x + 20, y + 25, 15, 12);
            ctx.fillRect(x + 50, y + 25, 15, 12);
            
            ctx.fillStyle = colors.black;
            ctx.fillRect(x + 24, y + 28, 7, 6);
            ctx.fillRect(x + 54, y + 28, 7, 6);
            
            ctx.fillStyle = colors.black;
            ctx.fillRect(x + 25, y + 50, 40, 5);
            ctx.fillRect(x + 22, y + 47, 5, 4);
            ctx.fillRect(x + 63, y + 47, 5, 4);
            
            ctx.fillStyle = colors.orange;
            ctx.fillRect(x, y + 10, w, 15);
            ctx.fillRect(x + 10, y, w - 20, 10);
            
            ctx.fillStyle = colors.yellow;
            ctx.font = 'bold 24px Arial';
            ctx.fillText('M', x + w/2 - 8, y + 73);
            
            ctx.globalAlpha = 1;
            
            const barWidth = 200;
            const barHeight = 20;
            const barX = canvas.width/2 - barWidth/2;
            const barY = 50;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(barX - 5, barY - 5, barWidth + 10, barHeight + 10);
            
            ctx.fillStyle = colors.red;
            ctx.fillRect(barX, barY, barWidth, barHeight);
            
            const hpPercent = boss.hp / boss.maxHp;
            ctx.fillStyle = hpPercent > 0.3 ? colors.lime : colors.orange;
            ctx.fillRect(barX, barY, barWidth * hpPercent, barHeight);
            
            ctx.strokeStyle = colors.black;
            ctx.lineWidth = 3;
            ctx.strokeRect(barX, barY, barWidth, barHeight);
            
            ctx.font = 'bold 14px Courier';
            ctx.fillStyle = colors.white;
            ctx.textAlign = 'center';
            ctx.fillText(`RONALD McDONALD: ${boss.hp}/${boss.maxHp}`, canvas.width/2, barY + 15);
            ctx.textAlign = 'left';
        }

        function draw() {
            ctx.save();
            ctx.translate(cameraOffsetX, cameraOffsetY);
            
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, colors.sky1);
            gradient.addColorStop(0.4, colors.sky2);
            gradient.addColorStop(1, '#2a4a6e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            stars.forEach(star => {
                const alpha = (Math.sin(star.twinkle * 0.05) + 1) / 2;
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.6})`;
                ctx.fillRect(star.x, star.y, star.size, star.size);
            });

            birds.forEach(bird => {
                const wing = Math.sin(bird.wingFrame) > 0;
                ctx.fillStyle = colors.black;
                ctx.fillRect(bird.x, bird.y, 8, 3);
                if (wing) {
                    ctx.fillRect(bird.x - 3, bird.y - 2, 4, 2);
                    ctx.fillRect(bird.x + 7, bird.y - 2, 4, 2);
                } else {
                    ctx.fillRect(bird.x - 2, bird.y - 3, 3, 2);
                    ctx.fillRect(bird.x + 7, bird.y - 3, 3, 2);
                }
            });
            
            buildings.forEach(b => {
                ctx.fillStyle = b.color;
                ctx.fillRect(b.x, b.y, b.width, b.height);
                
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 2;
                ctx.strokeRect(b.x, b.y, b.width, b.height);
                
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 4; j++) {
                        ctx.fillStyle = Math.random() > 0.5 ? colors.yellow : colors.black;
                        ctx.fillRect(b.x + 10 + i * 20, b.y + 20 + j * 25, 12, 15);
                    }
                }
            });
            
            clouds.forEach(cloud => {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.fillRect(cloud.x, cloud.y, cloud.size, cloud.size * 0.6);
                ctx.fillRect(cloud.x + cloud.size * 0.3, cloud.y - cloud.size * 0.2, cloud.size * 0.7, cloud.size * 0.5);
            });
            
            const tileSize = 60;
            for (let x = 0; x < canvas.width; x += tileSize) {
                for (let y = groundY + player.height; y < canvas.height; y += tileSize) {
                    const checker = ((x/tileSize + y/tileSize) % 2 === 0);
                    ctx.fillStyle = checker ? '#77CC77' : '#66BB66';
                    ctx.fillRect(x - (frame * 2.5) % tileSize, y, tileSize, tileSize);
                    
                    ctx.strokeStyle = colors.black;
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x - (frame * 2.5) % tileSize, y, tileSize, tileSize);
                }
            }
            
            drawPlayer();
            
            obstacles.forEach(obs => {
                const pulse = Math.sin(obs.pulseFrame) * 0.3 + 0.7;
                
                ctx.fillStyle = `rgba(255, 0, 0, ${pulse * 0.5})`;
                ctx.fillRect(obs.x - 14, obs.y - 14, obs.width + 28, obs.height + 28);
                
                ctx.fillStyle = colors.red;
                ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
                
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 4;
                ctx.strokeRect(obs.x, obs.y, obs.width, obs.height);
                
                ctx.fillStyle = colors.yellow;
                ctx.font = 'bold 32px Arial';
                ctx.fillText('!', obs.x + obs.width/2 - 7, obs.y + obs.height/2 + 12);
            });
            
            collectibles.forEach(col => {
                const floatY = col.y + Math.sin(col.floatOffset) * 12;
                
                for (let i = 3; i > 0; i--) {
                    ctx.fillStyle = `rgba(50, 205, 50, ${0.15 * i})`;
                    ctx.fillRect(col.x - i * 8, floatY - i * 8, col.width + i * 16, col.height + i * 16);
                }
                
                ctx.fillStyle = colors.lime;
                ctx.fillRect(col.x, floatY, col.width, col.height);
                
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 4;
                ctx.strokeRect(col.x, floatY, col.width, col.height);
                
                ctx.font = '36px Arial';
                ctx.fillText(col.emoji, col.x + 4, floatY + 34);
                
                if (frame % 20 < 10) {
                    ctx.fillStyle = colors.yellow;
                    ctx.fillRect(col.x - 6, floatY + 10, 6, 6);
                    ctx.fillRect(col.x + col.width, floatY + 10, 6, 6);
                    ctx.fillRect(col.x + col.width/2 - 3, floatY - 10, 6, 6);
                }
            });
            
            if (shopIcon) {
                const floatY = shopIcon.y + Math.sin(shopIcon.floatOffset) * 15;
                
                ctx.fillStyle = `rgba(255, 215, 0, 0.5)`;
                ctx.fillRect(shopIcon.x - 20, floatY - 20, shopIcon.width + 40, shopIcon.height + 40);
                
                ctx.fillStyle = colors.yellow;
                ctx.fillRect(shopIcon.x, floatY, shopIcon.width, shopIcon.height);
                
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 5;
                ctx.strokeRect(shopIcon.x, floatY, shopIcon.width, shopIcon.height);
                
                ctx.font = 'bold 50px Arial';
                ctx.fillText('üè™', shopIcon.x + 6, floatY + 46);
                
                ctx.font = 'bold 14px Courier';
                ctx.fillStyle = colors.black;
                ctx.fillText('SHOP', shopIcon.x + 10, floatY - 10);
            }
            
            specialChars.forEach(sc => drawSpecialChar(sc));
            
            bossProjectiles.forEach(proj => {
                const floatY = proj.y + Math.sin(proj.floatOffset) * 6;
                
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.fillRect(proj.x - 8, floatY - 8, proj.width + 16, proj.height + 16);
                
                ctx.font = '40px Arial';
                ctx.fillText(proj.emoji, proj.x, floatY + 30);
            });
            
            drawBoss();
            
            particles.forEach(p => {
                if (p.emoji) {
                    ctx.font = '16px Arial';
                    ctx.globalAlpha = p.life / 25;
                    ctx.fillText(p.emoji, p.x, p.y);
                } else {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life / 45;
                    ctx.fillRect(p.x, p.y, p.size, p.size);
                }
                ctx.globalAlpha = 1;
            });
            
            floatingTexts.forEach(ft => {
                ft.scale += ft.scaleDir * 0.02;
                if (ft.scale > 1.15 || ft.scale < 0.95) ft.scaleDir *= -1;
                
                ctx.save();
                ctx.translate(ft.x, ft.y);
                ctx.scale(ft.scale, ft.scale);
                
                ctx.font = `bold ${ft.fontSize}px Courier`;
                ctx.fillStyle = ft.color;
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 5;
                ctx.globalAlpha = Math.min(1, ft.life / 40);
                ctx.strokeText(ft.text, 0, 0);
                ctx.fillText(ft.text, 0, 0);
                
                ctx.restore();
                ctx.globalAlpha = 1;
            });
            
            ctx.restore();
            
            // ‚úÖ CHAR ALERT
            if (charAlert) {
                const alpha = Math.min(1, charAlert.life / 30);
                ctx.globalAlpha = alpha;
                
                ctx.fillStyle = 'rgba(255, 215, 0, 0.95)';
                const padding = 20;
                const textWidth = ctx.measureText(charAlert.text).width + padding * 2;
                const alertX = canvas.width - textWidth - 20;
                const alertY = charAlert.y;
                
                ctx.fillRect(alertX, alertY, textWidth, 50);
                
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 4;
                ctx.strokeRect(alertX, alertY, textWidth, 50);
                
                ctx.font = 'bold 20px Courier';
                ctx.fillStyle = colors.black;
                ctx.fillText(charAlert.text, alertX + padding, alertY + 32);
                
                ctx.globalAlpha = 1;
            }
            
            drawHUD();
            
            // ‚úÖ TUTORIAL M√ÅS COMPACTO
            if (showTutorial) {
                ctx.globalAlpha = tutorialAlpha;
                
                ctx.fillStyle = colors.yellow;
                ctx.font = 'bold 32px Courier';
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 4;
                ctx.textAlign = 'center';
                ctx.strokeText('TAP = SALTAR!', canvas.width/2, canvas.height/2);
                ctx.fillText('TAP = SALTAR!', canvas.width/2, canvas.height/2);
                ctx.textAlign = 'left';
                
                ctx.globalAlpha = 1;
            }
        }

        function drawHUD() {
            // ‚úÖ HUD COMPACTO PARA M√ìVIL
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(15, 15, 170, 70);
            
            ctx.strokeStyle = colors.yellow;
            ctx.lineWidth = 3;
            ctx.strokeRect(15, 15, 170, 70);
            
            ctx.font = 'bold 14px Courier';
            ctx.fillStyle = colors.yellow;
            ctx.fillText('SCORE', 25, 35);
            
            ctx.font = 'bold 32px Courier';
            ctx.fillStyle = colors.cyan;
            ctx.fillText(score, 25, 68);
            
            ctx.font = '28px Arial';
            for (let i = 0; i < player.maxLives; i++) {
                ctx.fillText(i < player.lives ? '‚ù§Ô∏è' : 'üñ§', 200 + i * 38, 45);
            }
            
            if (selectedChar.powerCooldown > 0) {
                const barWidth = 130;
                const barHeight = 10;
                const barX = 200;
                const barY = 65;
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                const powerPercent = Math.min(1, player.powerCharge / selectedChar.powerCooldown);
                
                let barColor = selectedChar.color;
                if (powerPercent >= 1 && !player.powerActive) {
                    barColor = colors.yellow;
                    if (frame % 20 < 10) barColor = colors.white;
                }
                
                ctx.fillStyle = barColor;
                ctx.fillRect(barX, barY, barWidth * powerPercent, barHeight);
                
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 2;
                ctx.strokeRect(barX, barY, barWidth, barHeight);
            }
            
            if (combo > 1) {
                ctx.fillStyle = 'rgba(255, 215, 0, 0.9)';
                ctx.fillRect(canvas.width - 110, 15, 95, 40);
                ctx.strokeStyle = colors.pink;
                ctx.lineWidth = 3;
                ctx.strokeRect(canvas.width - 110, 15, 95, 40);
                
                ctx.font = 'bold 13px Courier';
                ctx.fillStyle = colors.black;
                ctx.fillText('COMBO', canvas.width - 100, 32);
                ctx.font = 'bold 22px Courier';
                ctx.fillStyle = colors.pink;
                ctx.fillText('x' + combo, canvas.width - 70, 50);
            }
            
            if (player.chefMode > 0) {
                ctx.fillStyle = 'rgba(255, 215, 0, 0.9)';
                ctx.fillRect(15, canvas.height - 60, canvas.width - 30, 45);
                ctx.strokeStyle = colors.orange;
                ctx.lineWidth = 4;
                ctx.strokeRect(15, canvas.height - 60, canvas.width - 30, 45);
                
                ctx.font = 'bold 26px Courier';
                ctx.fillStyle = colors.orange;
                ctx.strokeStyle = colors.black;
                ctx.lineWidth = 4;
                ctx.textAlign = 'center';
                ctx.strokeText('‚ú® CHEF MODE! ‚ú®', canvas.width/2, canvas.height - 28);
                ctx.fillText('‚ú® CHEF MODE! ‚ú®', canvas.width/2, canvas.height - 28);
                ctx.textAlign = 'left';
            }
            
            if (!boss) {
                const currentM = missions[currentMission];
                if (currentM && !currentM.complete) {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(15, 95, canvas.width - 30, 50);
                    
                    ctx.strokeStyle = colors.cyan;
                    ctx.lineWidth = 3;
                    ctx.strokeRect(15, 95, canvas.width - 30, 50);
                    
                    ctx.font = 'bold 11px Courier';
                    ctx.fillStyle = colors.cyan;
                    ctx.fillText('MISI√ìN:', 25, 112);
                    
                    ctx.font = 'bold 16px Courier';
                    ctx.fillStyle = colors.white;
                    ctx.fillText(currentM.desc, 25, 133);
                    
                    if (currentM.type !== 'ivancito' && currentM.type !== 'luisito' && currentM.type !== 'chef') {
                        const barWidth = canvas.width - 90;
                        const barX = 25;
                        const barY = 115;
                        const progress = Math.min(1, currentM.progress / currentM.target);
                        
                        ctx.fillStyle = colors.yellow;
                        ctx.fillRect(barX + 135, barY, barWidth - 135, 6);
                        
                        ctx.strokeStyle = colors.black;
                        ctx.lineWidth = 2;
                        ctx.strokeRect(barX + 135, barY, barWidth - 135, 6);
                        
                        ctx.fillStyle = colors.lime;
                        ctx.fillRect(barX + 135, barY, (barWidth - 135) * progress, 6);
                        
                        ctx.font = 'bold 10px Courier';
                        ctx.fillStyle = colors.yellow;
                        ctx.fillText(`${currentM.progress}/${currentM.target}`, barX + barWidth - 35, barY + 5);
                    }
                }
            }
        }

        function gameLoop() {
            if (!gameStarted || gameOver || paused) return;
            
            update();
            draw();
            
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
